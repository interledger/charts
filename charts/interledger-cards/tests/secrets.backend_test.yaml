suite: interledger-cards backend - secrets
templates:
  - secrets.backend.yaml
set:
  fullnameOverride: test-cards
tests:
  - it: 'Secret should be created when shouldCreateSecrets is true'
    set:
      config:
        backend:
          shouldCreateSecrets: true
    asserts:
      - equal:
          path: metadata.name
          value: test-cards-backend
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: test-cards-backend
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-cards
      - equal:
          path: kind
          value: Secret
      - equal:
          path: apiVersion
          value: v1
  - it: 'Secret should not be created when shouldCreateSecrets is false'
    set:
      config:
        backend:
          shouldCreateSecrets: false
    asserts:
      - hasDocuments:
          count: 0
  - it: 'Secret should contain encoded database URL'
    set:
      config:
        backend:
          shouldCreateSecrets: true
          databaseUrlSecret: "postgresql://testuser:testpass@testhost:5432/testdb"
    asserts:
      - equal:
          path: data.databaseUrlSecret
          value: cG9zdGdyZXNxbDovL3Rlc3R1c2VyOnRlc3RwYXNzQHRlc3Rob3N0OjU0MzIvdGVzdGRi
  - it: 'Secret should contain encoded cookie secret'
    set:
      config:
        backend:
          shouldCreateSecrets: true
          cookieSecret: "mysecretcookie"
    asserts:
      - equal:
          path: data.cookieSecret
          value: bXlzZWNyZXRjb29raWU=
  - it: 'Secret should use default values when not overridden'
    set:
      config:
        backend:
          shouldCreateSecrets: true
    asserts:
      - equal:
          path: data.databaseUrlSecret
          value: cG9zdGdyZXNxbDovL3VzZXJuYW1lOnBhc3N3b3JkQGhvc3Q6cG9ydC9kYXRhYmFzZT9zc2xtb2RlPWRpc2FibGU=
      - equal:
          path: data.cookieSecret
          value: c3VwZXJzZWNyZXRjb29raWU=
