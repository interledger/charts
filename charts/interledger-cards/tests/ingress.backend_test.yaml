suite: interledger-cards backend - ingress
templates:
  - ingress.backend.yaml
set:
  fullnameOverride: test-cards
tests:
  - it: 'Ingress should be created when backend ingress is enabled'
    asserts:
      - equal:
          path: metadata.name
          value: test-cards-backend
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: test-cards
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-cards
      - equal:
          path: kind
          value: Ingress
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1
  - it: 'Ingress should not be created when backend ingress is disabled'
    set:
      ingress:
        backend:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0
  - it: 'Ingress should have correct host and path configuration'
    asserts:
      - equal:
          path: spec.rules[0].host
          value: interledger.cards
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Prefix
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: interledger-cards-service
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 3000
  - it: 'Ingress should have TLS configuration'
    asserts:
      - equal:
          path: spec.tls[0].secretName
          value: interledger-cards-tls
      - contains:
          path: spec.tls[0].hosts
          content: interledger.cards
  - it: 'Ingress should have nginx rewrite annotation when className is nginx'
    set:
      ingress:
        backend:
          className: nginx
    asserts:
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/rewrite-target"]
          value: /
  - it: 'Ingress should support custom hosts'
    set:
      ingress:
        backend:
          hosts:
            - host: custom.example.com
              paths:
                - path: /api
                  pathType: Prefix
                  service:
                    name: custom-service
                    port: 8080
    asserts:
      - equal:
          path: spec.rules[0].host
          value: custom.example.com
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /api
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: custom-service
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8080
