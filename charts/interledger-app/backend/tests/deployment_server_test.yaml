suite: Interledger App - Deployment for server
templates:
  - deployment.server.yaml
set:
  fullnameOverride: wallet-backend
  server:
    replicaCount: 33
    nodeSelector: {}
    serviceAccount:
      create: false
      annotations: {}
      name: "cheeseman"
    # Warning: Please remember to update all tag versions to the same version, always!
    containers:
      # Backend server task
      - name: server
        image:
          repository: europe-west4-docker.pkg.dev/wallet-451208/interledger-app
          name: backend
          tag: manual_main
          pullPolicy: Always
        args:
          - "start"
        envFrom:
          - configMapRef:
              name: "{{ .Release.Name }}"
          - secretRef:
              name: "{{ .Release.Name }}"
        resources:
          requests:
            memory: 128Mi
            cpu: 200m
          limits:
            memory: 512Mi
            cpu: 400m
        ports:
          - name: grpc
            containerPort: 8443
          - name: admin
            containerPort: 8448
          - name: http
            containerPort: 8080
release:
  name: wallet-backend
tests:
  - it: 'Should create a deployment called wallet-backend-server'
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: metadata.name
          value: wallet-backend-server
  - it: 'Should be using service account "cheeseman"'
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: cheeseman
  - it: 'Should have correct selector labels'
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: wallet-backend-server
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: wallet-backend-server
  - it: 'Should have correct template labels'
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: wallet-backend-server
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: wallet-backend-server
  - it: 'Should have attributes from the spec'
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: europe-west4-docker.pkg.dev/wallet-451208/interledger-app/backend:manual_main
      - equal:
          path: spec.template.spec.containers[0].args[0]
          value: start
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
          value: wallet-backend
      - equal:
          path: spec.template.spec.containers[0].envFrom[1].secretRef.name
          value: wallet-backend
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi
# The idea is that the rest should have been tested in common

