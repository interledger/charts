suite: Interledger App - Deployment for worker
templates:
  - configMap.yaml
  - deployment.worker.yaml
set:
  fullnameOverride: wallet-backend
  worker:
    replicaCount: 22
    nodeSelector: {}
    serviceAccount:
      create: false
      annotations: {}
      name: "cheeseman4worker"
    # Warning: Please remember to update all tag versions to the same version, always!
    containers:
      # Backend worker task
      - name: worker
        image:
          repository: europe-west4-docker.pkg.dev/wallet-451208/interledger-app
          name: backend
          tag: worker_image
          pullPolicy: Always
        args:
          - "start"
        envFrom:
          - configMapRef:
              name: "{{ .Release.Name }}"
          - secretRef:
              name: "{{ .Release.Name }}"
        resources:
          requests:
            memory: 128Mi
            cpu: 200m
          limits:
            memory: 512Mi
            cpu: 400m
        ports:
          - name: grpc
            containerPort: 8443
          - name: admin
            containerPort: 8448
          - name: http
            containerPort: 8080
release:
  name: wallet-backend
tests:
  - it: 'Should be using service account "cheeseman4worker"'
    template: deployment.worker.yaml
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: cheeseman4worker
  - it: 'Should have correct template labels'
    template: deployment.worker.yaml  
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: wallet-backend
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: wallet-backend-worker
  - it: 'Should have attributes from the spec'
    template: deployment.worker.yaml  
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[0]
          value: start
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
          value: wallet-backend
      - equal:
          path: spec.template.spec.containers[0].envFrom[1].secretRef.name
          value: wallet-backend
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi


