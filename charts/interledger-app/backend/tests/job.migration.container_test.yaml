suite: Interledger App - Migration job spawn
templates:
  - initialisation.yaml
set:
  fullnameOverride: wallet-backend
  initialisation:
    serviceAccountName: myServiceAccount
    host: "cloudsql-db-admin"
    port: "5432"
    backend:
      dbname: "wallet_backend"
      username: "wallet_backend_user"
      password: "wallet_backend_password"
    pacioli:
      dbname: "pacioli"
      username: "pacioli_user"
      password: "pacioli_password"
    rafiki_backend:
      dbname: "rafiki_backend"
      username: "rafiki_backend_user"
      password: "rafiki_backend_password"
    rafiki_auth:
      dbname: "rafiki_auth"
      username: "rafiki_auth_user"
      password: "rafiki_auth_password"
release:
  name: wallet-backend
tests:
  - it: 'Should run as the specified service account'
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: myServiceAccount
  - it: 'Should have expected environment variables for DB urls in migration job'
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: DB_URL_WITH_CERTS
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: wallet-backend
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.key
          value: dbBackendMigrationsURL
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: PACIOLI_DB_URL_WITH_CERTS
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.name
          value: wallet-backend
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.key
          value: dbPacioliMigrationsURL