#
# Chart for the Interledger App Wallet backend.
#

# Configuration that will be used during the migrations.
# Migrations will run as a separate job before the application starts using helm hooks.
# See templates/initialisation.yaml for more details on how the job is created.

# You can override the version of the image used used across the chart here.
# versionOverride: "v0.2.0"

initialisation: 
  serviceAccountName: ""
  host: "localhost"
  port: "5432"
  backend:
    urlSecretRef: "db-backend-url"
  pacioli:
    urlSecretRef: "db-pacioli-url"
  rafiki_backend:
    urlSecretRef: "db-rafiki-backend-url"
  rafiki_auth:
    urlSecretRef: "db-rafiki-auth-url"

  # What image should be used for the initialisation job.
  image:
    repository: europe-west4-docker.pkg.dev/wallet-451208/interledger-app
    name: backend
    imagePullPolicy: Always

database:
  host: "postgresql-host"
  port: "5432"
  backend:
    urlSecretRef: "db-backend-url"
  pacioli:
    urlSecretRef: "db-pacioli-url"
  rafiki_backend:
    urlSecretRef: "db-rafiki-backend-url"
  rafiki_auth:
    urlSecretRef: "db-rafiki-auth-url"

config:
  environment: dev
  log_level: "info"
  usd_ledger_id: "1"
  noop_equity_account_id: "00000000-0000-0000-0000-000000000000"
  google_oauth2_client_id: "google_oauth"
  authorisation_port: "8082"
  open_payments_port: "8081"

  admin:
    policy_aud: "0000000000000000000000000000000000000000000000000000000000000000"
    team_domain: "https://fynbos.cloudflareaccess.com"

  twilio:
    account_sid: "0000000000000000000000000000000000"
    service_sid: "VA00000000000000000000000000000000"
    account_token_ref: "twilio-account-token"

  zenddesk:
    user: "support@interledger-app.dev"
    token_ref: "zendesk-token"

  kratos:
    url: "http://kratos.wallet:4433"
    admin_url: "http://kratos.wallet:4434"
  
  rafiki:
    graphql:
      auth_url: "http://rafiki-auth:3003/graphql"
      backend_url: "http://rafiki-backend:3001/graphql"

  temporal:
    url: "temporal:7233"

  otel:
    exporter_otlp_endpoint: "grpc://api.honeycomb.io:443"
    exporter_otlp_headers: "x-honeycomb-team=0000000000000000000000"
    service_name: "backend"

  vault:
    url: "http://vault:8200"
    transit_engine_path: "transit/prod/backend"

  astra:
    client_id_ref: "astra-client-id"
    client_secret_ref: "astra-client-secret"
    webhook_bearer_token_ref: "astra-webhook-bearer-token"

  gatehub:
    app_id_ref: "gatehub-app"
    secret_ref: "gatehub-secret"
    webhook_secret_ref: "gatehub-webhook-secret"

  chimoney:
    webhook_secret_ref: "chimoney-webhook-secret"
    token_ref: "chimoney-token"

  sendgrid:
    api_key_ref: "sendgrid-api-key"


  pusher:
    addr_ref: "pusher-addr"

  segment:
    key_ref: "segment-key"

  slack:
    client_id_ref: "slack-client-id"
    client_secret_ref: "slack-client-secret"
    signing_secret_ref: "slack-signing-secret"
  
  basis_theory:
    api_key_ref: "basis-theory-api-key"
    token_ref: "basis-theory-token"

  persona:
    token_ref: "persona-token"
    webhook_token_ref: "persona-webhook-token"

  cdn:
    key_ref: "cdn-key"
  
  xago:
    api_secret_ref: "xago-api-secret"
    api_public_key_ref: "xago-api-public-key"

  sentry:
    dsn_ref: "sentry-dsn"

  
  pti: # FIANT configuration
    jwk_ref: "pti-jwk"
    client_id_ref: "pti-client-id"

server:
  replicaCount: 3
  nodeSelector: {}
  serviceAccount:
    create: false
    annotations: {}
    name: ""

  containers:
    # Backend server task
    - name: server
      image:
        repository: europe-west4-docker.pkg.dev/wallet-451208/interledger-app
        name: backend
        imageimagePullPolicy: Always
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8448
      readinessProbe:
        httpGet:
          path: /healthz
          port: 8448
      args:
        - "start"
      envFrom:
        - configmapRef:
            # Ensures that the configMap reference name is the one generated by the common chart
            name: '{{ include "common.fullname" . }}'
        - secretRef:
            name: DB_URL_WITH_CERTS
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.backend.urlSecretRef }}"
        - secretRef:
            name: PACIOLI_DB_URL_WITH_CERTS
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.pacioli.urlSecretRef }}"
        - secretRef:
            name: RAFIKI_DB_URL_WITH_CERTS
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.rafiki_backend.urlSecretRef }}"
        - secretRef:
            name: TWILIO_ACCOUNT_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "twilio-account-token"
        - secretRef:
            name: ZENDESK_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "zendesk-token"
        - secretRef:
            name: SENDGRID_API_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "sendgrid-api-key"
        - secretRef:
            name: PUSHER_ADDR
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "pusher-addr"
        - secretRef:
            name: SEGMENT_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "segment-key"
        - secretRef:
            name: PERSONA_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "persona-token"
        - secretRef:
            name: PERSONA_WEBHOOK_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "persona-webhook-token"
        - secretRef:
            name: BASIS_THEORY_API_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "basis-theory-api-key"
        - secretRef:
            name: BT_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "basis-theory-token"
        - secretRef:
            name: CDN_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "cdn-key"
        - secretRef:
            name: SENTRY_DSN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "sentry-dsn"
        - secretRef:
            name: XAGO_API_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "xago-api-secret"
        - secretRef:
            name: XAGO_API_PUBLIC_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "xago-api-public-key"
        - secretRef:
            name: ASTRA_WEBHOOK_BEARER_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.webhook_bearer_token_ref }}"
        - secretRef:
            name: ASTRA_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_id_ref }}"
        - secretRef:
            name: ASTRA_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_secret_ref }}"
        - secretRef:
            name: SLACK_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_id_ref }}"
        - secretRef:
            name: SLACK_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_secret_ref }}"
        - secretRef:
            name: SLACK_SIGNING_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.signing_secret_ref }}"
        - secretRef:
            name: GATEHUB_APP_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.app_id_ref }}"
        - secretRef:
            name: GATEHUB_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.secret_ref }}"
        - secretRef:
            name: GATEHUB_WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.webhook_secret_ref }}"
        - secretRef:
            name: CHIMONEY_WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.webhook_secret_ref }}"
        - secretRef:
            name: CHIMONEY_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.token_ref }}"
        - secretRef:
            name: PTI_JWK
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.jwk_ref }}"
        - secretRef:
            name: PTI_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.client_id_ref }}"

      resources:
        requests:
          memory: 128Mi
          cpu: 200m
        limits:
          memory: 512Mi
          cpu: 400m
      ports:
        - name: grpc
          containerPort: 8443
        - name: admin
          containerPort: 8448
        - name: http
          containerPort: 8080
worker:
  replicaCount: 3
  nodeSelector: {}
  serviceAccount:
    create: false
    annotations: {}
    name: ""

  containers:
    # Temporal related worker task
    - name: worker
      image:
        repository: europe-west4-docker.pkg.dev/wallet-451208/interledger-app
        name: backend
        imagePullPolicy: Always
      args:
        - "worker"
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
      readinessProbe:
        httpGet:
          path: /healthz
          port: 8080
      envFrom:
        - configmapRef:
            # Ensures that the configMap reference name is the one generated by the common chart
            name: '{{ include "common.fullname" . }}'
        - secretRef:
            name: DB_URL_WITH_CERTS
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.backend.urlSecretRef }}"
        - secretRef:
            name: PACIOLI_DB_URL_WITH_CERTS
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.pacioli.urlSecretRef }}"
        - secretRef:
            name: RAFIKI_DB_URL_WITH_CERTS
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.rafiki_backend.urlSecretRef }}"
        - secretRef:
            name: TWILIO_ACCOUNT_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "twilio-account-token"
        - secretRef:
            name: ZENDESK_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "zendesk-token"
        - secretRef:
            name: SENDGRID_API_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "sendgrid-api-key"
        - secretRef:
            name: PUSHER_ADDR
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "pusher-addr"
        - secretRef:
            name: SEGMENT_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "segment-key"
        - secretRef:
            name: PERSONA_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "persona-token"
        - secretRef:
            name: PERSONA_WEBHOOK_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "persona-webhook-token"
        - secretRef:
            name: BASIS_THEORY_API_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "basis-theory-api-key"
        - secretRef:
            name: BT_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "basis-theory-token"
        - secretRef:
            name: CDN_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "cdn-key"
        - secretRef:
            name: SENTRY_DSN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "sentry-dsn"
        - secretRef:
            name: XAGO_API_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "xago-api-secret"
        - secretRef:
            name: XAGO_API_PUBLIC_KEY
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "xago-api-public-key"
        - secretRef:
            name: ASTRA_WEBHOOK_BEARER_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.webhook_bearer_token_ref }}"
        - secretRef:
            name: ASTRA_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_id_ref }}"
        - secretRef:
            name: ASTRA_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_secret_ref }}"
        - secretRef:
            name: SLACK_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_id_ref }}"
        - secretRef:
            name: SLACK_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_secret_ref }}"
        - secretRef:
            name: SLACK_SIGNING_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.signing_secret_ref }}"
        - secretRef:
            name: GATEHUB_APP_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.app_id_ref }}"
        - secretRef:
            name: GATEHUB_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.secret_ref }}"
        - secretRef:
            name: GATEHUB_WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.webhook_secret_ref }}"
        - secretRef:
            name: CHIMONEY_WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.webhook_secret_ref }}"
        - secretRef:
            name: CHIMONEY_TOKEN
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.token_ref }}"
        - secretRef:
            name: PTI_JWK
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.jwk_ref }}"
        - secretRef:
            name: PTI_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.client_id_ref }}"
      resources:
        requests:
          memory: 128Mi
          cpu: 200m
        limits:
          memory: 512Mi
          cpu: 400m

service:
  - name: service
    type: ClusterIP
    ports:
      # Private gRPC Server (Used by the Admin Portal)
      - port: 8448
        targetPort: 8448
        protocol: TCP
        name: admin
      # Handling of webhooks
      - port: 8080
        targetPort: 8080
        protocol: TCP
        name: http
      # Public gRPC Server (Used by Mobile & External applications)
      - port: 8443
        targetPort: 8443
        protocol: TCP
        name: grpc
        appProtocol: HTTP2

configmap:
  - files/config.yaml

