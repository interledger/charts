#
# Chart for the Interledger App Wallet backend.
#

# Configuration that will be used during the migrations.
# Migrations will run as a separate job before the application starts using helm hooks.
# See templates/initialisation.yaml for more details on how the job is created.

# You can override the version of the image used used across the chart here.
# versionOverride: "v0.2.0"

imageOverride:
  repository: europe-west4-docker.pkg.dev/wallet-451208/interledger-app
  name: backend

initialisation: 
  serviceAccountName: ""
  backend:
    urlSecretRef: "dbBackendMigrationsURL"
  pacioli:
    urlSecretRef: "dbPacioliMigrationsURL"
  rafiki_backend:
    urlSecretRef: "dbRafikiBackendURL"
  rafiki_auth:
    urlSecretRef: "dbRafikiAuthURL"

  # What image should be used for the initialisation job.
  image:
    repository: europe-west4-docker.pkg.dev/wallet-451208/interledger-app
    name: backend
  imagePullPolicy: Always

database:
  host: "postgresql-host"
  port: "5432"
  backend:
    urlSecretRef: "dbBackendURL"
  pacioli:
    urlSecretRef: "dbPacioliURL"
  rafiki_backend:
    urlSecretRef: "dbRafikiBackendURL"
  rafiki_auth:
    urlSecretRef: "dbRafikiAuthURL"

config:
  environment: dev
  log_level: "info"
  usd_ledger_id: "1"
  noop_equity_account_id: "00000000-0000-0000-0000-000000000000"
  google_oauth2_client_id: "google_oauth"
  authorisation_port: "8082"
  open_payments_port: "8081"

  admin:
    policy_aud: "0000000000000000000000000000000000000000000000000000000000000000"
    team_domain: "https://fynbos.cloudflareaccess.com"

  twilio:
    account_sid: "0000000000000000000000000000000000"
    service_sid: "VA00000000000000000000000000000000"
    account_token_ref: "twilioAccountToken"

  zenddesk:
    user: "support@interledger-app.dev"
    token_ref: "zendeskToken"

  kratos:
    url: "http://kratos.wallet:4433"
    admin_url: "http://kratos.wallet:4434"
  
  rafiki:
    graphql:
      auth_url: "http://rafiki-auth:3003/graphql"
      backend_url: "http://rafiki-backend:3001/graphql"

  temporal:
    url: "temporal:7233"

  otel:
    exporter_otlp_endpoint: "grpc://api.honeycomb.io:443"
    exporter_otlp_headers_ref: "otelExporterHeaders" # Value will be something like "x-honeycomb-team=0000000000000000000000"
    service_name: "backend"

  vault:
    url: "http://vault:8200"
    transit_engine_path: "transit/prod/backend"

  astra:
    client_id_ref: "astraClientID"
    client_secret_ref: "astraClientSecret"
    webhook_bearer_token_ref: "astraWebhookBearerToken"
    # note: what about account number etc?

  gatehub:
    app_id_ref: "gatehubAppID"
    secret_ref: "gatehubSecret"
    webhook_secret_ref: "gatehubWebhookSecret"

  chimoney:
    webhook_secret_ref: "chimoneyWebhookSecret"
    token_ref: "chimoneyToken"

  sendgrid:
    api_key_ref: "sendgridApiKey"


  pusher:
    addr_ref: "pusherAddr"

  segment:
    key_ref: "segmentKey"

  slack:
    client_id_ref: "slackClientID"
    client_secret_ref: "slackClientSecret"
    signing_secret_ref: "slackSigningSecret"
  
  basis_theory:
    api_key_ref: "basisTheoryApiKey"
    token_ref: "basisTheoryToken"

  persona:
    token_ref: "personaToken"
    webhook_token_ref: "personaWebhookToken"

  cdn:
    key_ref: "cdnKey"
  
  xago:
    api_secret_ref: "xagoApiSecret"
    api_public_key_ref: "xagoApiPublicKey"

  sentry:
    dsn_ref: "sentryDSN"

  
  pti: # FIANT configuration
    jwk_ref: "ptiJwk"
    client_id_ref: "ptiClientID"

server:
  replicaCount: 3
  nodeSelector: {}
  serviceAccount:
    create: false
    annotations: {}
    name: ""

  containers:
    # Backend server task
    - name: server
      imagePullPolicy: Always

      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
      readinessProbe:
        httpGet:
          path: /healthz
          port: 8080
      args:
        - "start"
      envFrom:
        - configMapRef:
            # Ensures that the configMap reference name is the one generated by the common chart
            name: '{{ include "common.fullname" . }}'        
      env:
        -  name: PGSSLMODE
           value: disable
        -  name: DB_URL
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.backend.urlSecretRef }}"
        -  name: PACIOLI_DB_URL
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.pacioli.urlSecretRef }}"
        -  name: DB_URL_WITH_CERTS
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.backend.urlSecretRef }}"
        -  name: PACIOLI_DB_URL_WITH_CERTS
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.pacioli.urlSecretRef }}"
        -  name: RAFIKI_DB_URL
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.rafiki_backend.urlSecretRef }}"
        -  name: TWILIO_ACCOUNT_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.twilio.account_token_ref }}"
        -  name: ZENDESK_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.zenddesk.token_ref }}"
        -  name: SENDGRID_API_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.sendgrid.api_key_ref }}"
        -  name: PUSHER_ADDR
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pusher.addr_ref }}"
        -  name: SEGMENT_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.segment.key_ref }}"
        -  name: PERSONA_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.persona.token_ref }}"
        -  name: PERSONA_WEBHOOK_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.persona.webhook_token_ref }}"
        -  name: BASIS_THEORY_API_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.basis_theory.api_key_ref }}"
        -  name: BT_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.basis_theory.token_ref }}"
        -  name: CDN_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.cdn.key_ref }}"
        -  name: SENTRY_DSN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.sentry.dsn_ref }}"
        -  name: XAGO_API_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.xago.api_secret_ref }}"
        -  name: XAGO_API_PUBLIC_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.xago.api_public_key_ref }}"
        -  name: ASTRA_WEBHOOK_BEARER_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.webhook_bearer_token_ref }}"
        -  name: ASTRA_CLIENT_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_id_ref }}"
        -  name: ASTRA_CLIENT_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_secret_ref }}"
        -  name: SLACK_CLIENT_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_id_ref }}"
        -  name: SLACK_CLIENT_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_secret_ref }}"
        -  name: SLACK_SIGNING_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.signing_secret_ref }}"
        -  name: GATEHUB_APP_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.app_id_ref }}"
        -  name: GATEHUB_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.secret_ref }}"
        -  name: GATEHUB_WEBHOOK_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.webhook_secret_ref }}"
        -  name: CHIMONEY_WEBHOOK_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.webhook_secret_ref }}"
        -  name: CHIMONEY_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.token_ref }}"
        -  name: PTI_JWK
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.jwk_ref }}"
        -  name: PTI_CLIENT_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.client_id_ref }}"
        -  name: OTEL_EXPORTER_OTLP_HEADERS
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.otel.exporter_otlp_headers_ref }}"

      resources:
        requests:
          memory: 128Mi
          cpu: 200m
        limits:
          memory: 512Mi
          cpu: 400m
      ports:
        - name: grpc
          containerPort: 8443
        - name: admin
          containerPort: 8448
        - name: http
          containerPort: 8080
worker:
  replicaCount: 3
  nodeSelector: {}
  serviceAccount:
    create: false
    annotations: {}
    name: ""

  containers:
    # Temporal related worker task
    - name: worker
      imagePullPolicy: Always
      args:
        - "worker"
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8081
      readinessProbe:
        httpGet:
          path: /healthz
          port: 8081
      envFrom:
        - configMapRef:
            # Ensures that the configMap reference name is the one generated by the common chart
            name: '{{ include "common.fullname" . }}'
      env:
        -  name: PGSSLMODE
           value: disable
        -  name: DB_URL
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.backend.urlSecretRef }}"
        -  name: PACIOLI_DB_URL
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.pacioli.urlSecretRef }}"
        -  name: DB_URL_WITH_CERTS
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.backend.urlSecretRef }}"
        -  name: PACIOLI_DB_URL_WITH_CERTS
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.pacioli.urlSecretRef }}"
        -  name: RAFIKI_DB_URL
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.database.rafiki_backend.urlSecretRef }}"
        -  name: TWILIO_ACCOUNT_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.twilio.account_token_ref }}"
        -  name: ZENDESK_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.zenddesk.token_ref }}"
        -  name: SENDGRID_API_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.sendgrid.api_key_ref }}"
        -  name: PUSHER_ADDR
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pusher.addr_ref }}"
        -  name: SEGMENT_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.segment.key_ref }}"
        -  name: PERSONA_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.persona.token_ref }}"
        -  name: PERSONA_WEBHOOK_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.persona.webhook_token_ref }}"
        -  name: BASIS_THEORY_API_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.basis_theory.api_key_ref }}"
        -  name: BT_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.basis_theory.token_ref }}"
        -  name: CDN_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.cdn.key_ref }}"
        -  name: SENTRY_DSN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.sentry.dsn_ref }}"
        -  name: XAGO_API_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.xago.api_secret_ref }}"
        -  name: XAGO_API_PUBLIC_KEY
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.xago.api_public_key_ref }}"
        -  name: ASTRA_WEBHOOK_BEARER_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.webhook_bearer_token_ref }}"
        -  name: ASTRA_CLIENT_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_id_ref }}"
        -  name: ASTRA_CLIENT_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.astra.client_secret_ref }}"
        -  name: SLACK_CLIENT_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_id_ref }}"
        -  name: SLACK_CLIENT_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.client_secret_ref }}"
        -  name: SLACK_SIGNING_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.slack.signing_secret_ref }}"
        -  name: GATEHUB_APP_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.app_id_ref }}"
        -  name: GATEHUB_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.secret_ref }}"
        -  name: GATEHUB_WEBHOOK_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.gatehub.webhook_secret_ref }}"
        -  name: CHIMONEY_WEBHOOK_SECRET
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.webhook_secret_ref }}"
        -  name: CHIMONEY_TOKEN
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.chimoney.token_ref }}"
        -  name: PTI_JWK
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.jwk_ref }}"
        -  name: PTI_CLIENT_ID
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.pti.client_id_ref }}"
        -  name: OTEL_EXPORTER_OTLP_HEADERS
           valueFrom:
             secretKeyRef:
                name: '{{ include "common.fullname" . }}'
                key: "{{ .Values.config.otel.exporter_otlp_headers_ref }}"
      resources:
        requests:
          memory: 128Mi
          cpu: 200m
        limits:
          memory: 512Mi
          cpu: 400m

service:
  - name: service
    type: ClusterIP
    ports:
      # Private gRPC Server (Used by the Admin Portal)
      - port: 8448
        targetPort: 8448
        protocol: TCP
        name: admin
      # Handling of webhooks
      - port: 8080
        targetPort: 8080
        protocol: TCP
        name: http
      # Public gRPC Server (Used by Mobile & External applications)
      - port: 8443
        targetPort: 8443
        protocol: TCP
        name: grpc
        appProtocol: HTTP2

configmap:
  - files/config.yaml

