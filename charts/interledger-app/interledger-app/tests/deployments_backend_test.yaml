suite: interledger-app deployments - Backend Server and Worker
templates:
  - deployment-backend-server.yaml
  - deployment-backend-worker.yaml
set:
  fullnameOverride: test-interledger-app
  imageOverride:
    repository: test-registry
release:
  name: test-interledger-app
tests:
  - it: 'backend server deployment should be created when enabled'
    template: deployment-backend-server.yaml
    asserts:
      - equal:
          path: metadata.name
          value: test-interledger-app-backend-server
      - equal:
          path: spec.selector.matchLabels['app.kubernetes.io/component']
          value: backend-server
      - equal:
          path: spec.template.spec.containers[0].name
          value: interledger-app-backend-server
      - equal:
          path: spec.template.spec.containers[0].image
          value: test-registry/backend:1.0.0
      - equal:
          path: spec.template.spec.containers[0].args[0]
          value: start
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: grpc
            containerPort: 8443
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: admin
            containerPort: 8448
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 8080

  - it: 'backend worker deployment should be created when enabled'
    template: deployment-backend-worker.yaml
    asserts:
      - equal:
          path: metadata.name
          value: test-interledger-app-backend-worker
      - equal:
          path: spec.selector.matchLabels['app.kubernetes.io/component']
          value: backend-worker
      - equal:
          path: spec.template.spec.containers[0].name
          value: interledger-app-backend-worker
      - equal:
          path: spec.template.spec.containers[0].image
          value: test-registry/backend:1.0.0
      - equal:
          path: spec.template.spec.containers[0].args[0]
          value: worker

  - it: 'backend server deployment should not be created when disabled'
    template: deployment-backend-server.yaml
    set:
      deployments:
        backend:
          server:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: 'backend worker deployment should not be created when disabled'
    template: deployment-backend-worker.yaml
    set:
      deployments:
        backend:
          worker:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: 'backend deployments should have topology spread constraints'
    template: deployment-backend-server.yaml
    asserts:
      - isNotEmpty:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].maxSkew
          value: 1
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: kubernetes.io/hostname
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].whenUnsatisfiable
          value: DoNotSchedule
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].labelSelector.matchLabels['app.kubernetes.io/component']
          value: backend-server
