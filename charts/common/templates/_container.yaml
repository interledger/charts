{{- define "common.container.tpl" -}}
{{- $top := first . }}
{{- $container := index . 1 }}
{{- $pod := index . 2 }}

{{- $image := $container.image | default (dict) -}}
{{- $ovr := $top.Values.imageOverride | default (dict) -}}

{{- /* Merge repository/name first (prefer container > global > default) */ -}}
{{- $_ := set $image "repository" (coalesce $image.repository $ovr.repository "ghcr.io/interledger") -}}
{{- $_ := set $image "name"       (coalesce $image.name       $ovr.name       ($top.Chart.Name | default "container")) -}}

{{- /* Tag resolution (prefer container tag > versionOverride > global tag > Chart.AppVersion > latest) */ -}}
{{- $tag := coalesce $image.tag $top.Values.versionOverride $ovr.tag ($top.Chart.AppVersion | default "latest") -}}
{{- $_ := set $image "tag" $tag -}}

{{- /* Digest (prefer container > global) and guard against tag+digest together */ -}}
{{- $digest := coalesce $image.digest $ovr.digest -}}
{{- if $digest }}
  {{- $tag = "" -}}
  {{- $_ := set $image "tag" $tag -}}
  {{- $_ := set $image "digest" $digest -}}
{{- end }}

{{- if not $container.name }}
  {{- $_ := set $container "name" ($top.Chart.Name | default "container") }}
{{- end }}

{{- if not $image.tag }}
    {{- $_ := set $image "tag" ($top.Chart.AppVersion | default "latest") }}
    {{- if $top.Values.versionOverride }}
      {{- /* If versionOverride is set, use it as the tag */ -}}
      {{- $_ := set $image "tag" $top.Values.versionOverride }}
    {{- end }}
{{- end }}
{{- if not $container.imagePullPolicy }}
  {{ $_ := set $container "imagePullPolicy" "IfNotPresent" }}
{{- end }}
- name: {{ $container.name | default $top.Chart.Name }}
  securityContext:
    {{- toYaml $top.Values.securityContext | nindent 4 }}

  {{- if $image.digest }}
  image: {{ print $image.repository "/" $image.name "@sha256:" $image.digest }}
  {{- else }}
  image: {{ print $image.repository "/" $image.name ":" $image.tag }}
  {{- end }}

  imagePullPolicy: {{ $container.imagePullPolicy | quote | default "Always" }}
  resources:
    {{- toYaml $container.resources | nindent 4 }}

  {{- with $container.env }}
  env: {{- tpl (toYaml . | nindent 4) $top }}
  {{- end }}

  {{- if $container.envFrom }}
  {{- with $container.envFrom }}
  envFrom: {{- tpl (toYaml . | nindent 4) $top }}
  {{- end }}
  {{- end }}

  {{- with $container.command }}
  command: {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with $container.livenessProbe }}
  livenessProbe: {{ include "common.probe" (list $top .) | nindent 4 }}
  {{- end }}

  {{- with $container.readinessProbe }}
  readinessProbe: {{ include "common.probe" (list $top .) | nindent 4 }}
  {{- end }}

  {{- with $container.ports }}
  ports: {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with $container.args }}
  args: {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- if or ($pod.secretProvider) ($container.volumeMounts) }}
  volumeMounts:
    {{- range $secretProvider := $pod.secretProvider }}
    - name: {{ $secretProvider.name }}
      mountPath: {{ printf "/mnt/secrets-store-%s" $secretProvider.name }}
      readOnly: true
    {{- end }}
    {{- with $container.volumeMounts }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- end }}

{{- end }} # define

{{- define "common.container" -}}
{{- include "common.utils.merge" (append . "common.container.tpl") }}
{{- end }}
