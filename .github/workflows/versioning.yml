name: Chart Auto Versioning Preview on PR

on:
    pull_request_target:
        types: [labeled, opened, synchronize, reopened]
        branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
    bump:
        name: Preview of bump chart versions
        if: ${{ !startsWith(github.event.pull_request.head.ref, 'chore/version-bump') }}
        runs-on: ubuntu-latest
        steps:
        - name: Checkout code
          uses: actions/checkout@v5
          with:
            ref: ${{ github.event.pull_request.head.sha }}
            token: ${{ secrets.GITHUB_TOKEN }}
        - name: Set up Helm
          run: |
            curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
            chmod 700 get_helm.sh
            ./get_helm.sh
        - name: Fail if docs/interledger was modified
          run: |
            if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep '^docs/interledger/'; then
              echo "Changes to docs/interledger/ detected. Label with 'manual-versioning' if you are sure.";
              exit 1;
            fi

        - name: Bump chart versions (no-commit preview on PRs)
          uses: actions/github-script@v8
          with:
            script: |
                const { default: runPRVersioning } = await import('${{ github.workspace }}/tooling/runner.js')
                // Run in non-PR-commit mode so we don't write to PR branches.
                await runPRVersioning({ github, core, context, pullRequestMode: false })