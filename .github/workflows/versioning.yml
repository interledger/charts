name: Chart Auto Versioning Preview on PR

on:
    pull_request_target:
        types: [labeled, opened, synchronize, reopened]
        branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
    bump:
        name: Preview of bump chart versions
        if: ${{ !startsWith(github.event.pull_request.head.ref, 'chore/version-bump') }}
        runs-on: ubuntu-latest
        steps:
        - name: Checkout code
          uses: actions/checkout@v6
          with:
            ref: ${{ github.event.pull_request.head.sha }}
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Cache Helm binary
          id: cache-helm
          uses: actions/cache@v4
          with:
            path: /usr/local/bin/helm
            key: helm-v3.19.0-linux-amd64

        - name: Download Helm
          if: steps.cache-helm.outputs.cache-hit != 'true'
          run: |
            curl -fsSL https://get.helm.sh/helm-v3.19.0-linux-amd64.tar.gz -o helm.tar.gz
            tar -zxvf helm.tar.gz
            sudo mv linux-amd64/helm /usr/local/bin/helm
            rm -rf helm.tar.gz linux-amd64

        - name: Set Helm permissions
          run: sudo chmod +x /usr/local/bin/helm

        - name: Fail if docs/interledger was modified
          run: |
            if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep '^docs/interledger/'; then
              echo "Changes to docs/interledger/ detected. Label with 'manual-versioning' if you are sure.";
              exit 1;
            fi

        - name: Bump chart versions (no-commit preview on PRs)
          uses: actions/github-script@v8
          with:
            script: |
                const { default: runPRVersioning } = await import('${{ github.workspace }}/tooling/runner.js')
                // Run in non-PR-commit mode so we don't write to PR branches.
                await runPRVersioning({ github, core, context, pullRequestMode: false })