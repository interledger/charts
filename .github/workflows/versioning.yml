name: Chart Auto Versioning

on:
    pull_request_target:
        types: [labeled, opened, synchronize, reopened]
        branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
    bump:
        name: Bump chart versions
        runs-on: ubuntu-latest
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            ref: ${{ github.event.pull_request.head.sha }}
            token: ${{ secrets.GITHUB_TOKEN }}
        - name: Set up Helm
          run: |
            curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
            chmod 700 get_helm.sh
            ./get_helm.sh
        - name: Bump chart versions
          uses: actions/github-script@v7
          with:
            script: |
                const { default: runPRVersioning } = await import('${{ github.workspace }}/tooling/runner.js')
                await runPRVersioning({ github, core, context, pullRequestMode: true })