name: Chart Versioning on Merge

on:
  pull_request_target:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: versioning-on-merge
  cancel-in-progress: false

jobs:
  version-on-merge:
    if: github.event.pull_request.merged == true && !startsWith(github.event.pull_request.head.ref, 'chore/version-bump')
    runs-on: ubuntu-latest
    steps:
    - name: Checkout base branch (main)
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Sync local main with remote
      run: |
        git fetch origin main
        git checkout -B main origin/main
        git reset --hard origin/main
    - name: Set up Helm
      run: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh
    - name: Calculate and stage chart version bumps on main
      uses: actions/github-script@v7
      with:
        script: |
          // Skip if PR has manual-versioning label
          const pr = context.payload.pull_request;
          const { data: labels } = await github.rest.issues.listLabelsOnIssue({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.number,
          });
          if (labels.some(l => l.name === 'manual-versioning')) {
            core.info("PR has label 'manual-versioning'. Skipping automatic versioning on merge.");
            return;
          }
          const { default: runPRVersioning } = await import('${{ github.workspace }}/tooling/runner.js')
          await runPRVersioning({ github, core, context, pullRequestMode: false })
    - name: Remove installer artifacts
      run: rm -f get_helm.sh

    - name: Create version bump PR to main
      id: cpr
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ github.token }}
        commit-message: chore(version) - bump charts after merge of PR #${{ github.event.pull_request.number }}
        title: chore(version) - bump charts after merge of PR #${{ github.event.pull_request.number }}
        body: |
          Automated chart versioning after merge of PR #${{ github.event.pull_request.number }}.
          This PR updates Chart.yaml versions, packages updated charts into docs/interledger,
          and regenerates the Helm index.
        branch: chore/version-bump/pr-${{ github.event.pull_request.number }}
        base: main
        labels: |
          versioning
          automated
          automerge
        add-paths: |
          charts/**
          docs/interledger/**
        delete-branch: true

    - name: Approve PR
      env:
        GH_TOKEN: ${{ secrets.CI_BOT_PAT }}
      run: gh pr review ${{ github.event.pull_request.number }} --approve

    - name: Enable auto-merge (squash)
      if: ${{ steps.cpr.outputs.pull-request-number != '' }}
      uses: peter-evans/enable-pull-request-automerge@v3
      with:
        token: ${{ github.token }}
        pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
        merge-method: squash
